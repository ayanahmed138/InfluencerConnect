@model InfluencerConnect.Models.CampaignMessage

@{
    ViewBag.Title = "Create";
}
<!-- Breadcrumbs -->
<section class="inflanar-breadcrumb">
    <div class="container">
        <div class="row">
            <!-- Breadcrumb-Content -->
            <div class="col-12">
                <div class="inflanar-breadcrumb__inner">
                    <div class="inflanar-breadcrumb__content">
                        <h2 class="inflanar-breadcrumb__title m-0">Create Campaign</h2>
                        <ul class="inflanar-breadcrumb__menu list-none">
                            <li><a href="/home">Home</a></li>
                            <li class="active"><a href="/CampaignMessage/Create">Create Campaign</a></li>
                        </ul>
                    </div>
                    <div class="inflanar-breadcrumb__img">
                        <div class="inflanar-breadcrumb__thumb">
                            <img src="/Content/Images/in-bread-thumb.png">
                        </div>
                        <div class="inflanar-breadcrumb__group">
                            <img src="/Content/Images/in-social-group.png">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- End breadcrumbs -->

<div class="Partials">

</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")


    <script>

        $(document).ready(function () {
            $.ajax({
                url: '/CampaignMessages/_CreatePatial_A',
                dataType: 'html',
                success: function (data) {
                    $('.Partials').html(data);
                }
            });
           

            $(document).on('click', '#next1', function () {
                var content = $('#content').val();
                var shortDescripion = $('#shortDescripion').val();
                var startDate = $('#startDate').val();
                var endDate = $('#endDate').val();
                var longDescription = $('#endDate').val();
                var contentTypeId = $('#contentTypeId option:selected').val();
                var audienceId = $('#targetAudienceId option:selected').val();
                var categoryId = $('#categoryId option:selected').val();
               
                $.ajax({
                    url: '/CampaignMessages/_CreatePatial_B?content=' + content + '&shortDescription= ' + shortDescripion + '&startDate= ' + startDate + '&endDate= ' + endDate
                        + '&longDescription=' + longDescription + '&contentTypeId=' + contentTypeId + '&audienceTypeId=' + audienceId + '&categoryId=' +categoryId,
                    dataType: 'html',
                    success: function (data) {
                        $('.Partials').html(data);
                    }
                });
            })

            //const uploadContainer = $(document);

            //// Delegate click event to dynamically added elements
            //uploadContainer.on("click", ".upload-box", function (event) {
            //    const fileInput = $(this).find("input[type='file']");
            //    fileInput.trigger("click");
            //});

            //// Delegate change event for file input
            //uploadContainer.on("change", "input[type='file']", function (event) {
            //    if (event.target.files.length > 0) {
            //        const reader = new FileReader();
            //        const uploadBox = $(this).closest(".upload-box");

            //        reader.onload = function (e) {
            //            // Replace "+" label with uploaded image preview
            //            uploadBox.html(`
            //        <img src="${e.target.result}" alt="Uploaded Image">
            //        <button class="remove-icon">x</button>
            //    `);

            //            // Append a new upload box
            //            const timestamp = Date.now();
            //            const newUploadBox = $(`
            //        <div class="upload-box">
            //            <label for="upload-input-${timestamp}">+</label>
            //            <input type="file" id="upload-input-${timestamp}" accept="image/*" hidden>
            //        </div>
            //    `);
            //            $(".image-upload-container").append(newUploadBox);
            //        };

            //        reader.readAsDataURL(event.target.files[0]);
            //    }
            //});

            //// Delegate remove button click
            //uploadContainer.on("click", ".remove-icon", function () {
            //    $(this).parent().remove();
            //});
            const uploadContainer = $(document);
            let uploadedImages = []; // Store selected files

            // Open file dialog when clicking upload box
            uploadContainer.on("click", ".upload-box", function () {
                $(this).find("input[type='file']").trigger("click");
            });

            // Handle file selection
            uploadContainer.on("change", "input[type='file']", function (event) {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    const uploadBox = $(this).closest(".upload-box");

                    reader.onload = function (e) {
                        uploadBox.html(`
                    <img src="${e.target.result}" alt="Uploaded Image">
                    <button class="remove-icon">x</button>
                `);

                        uploadedImages.push(file); // Store file reference

                        // Add new upload box for more images
                        const timestamp = Date.now();
                        const newUploadBox = $(`
                    <div class="upload-box">
                        <label for="upload-input-${timestamp}">+</label>
                        <input type="file" id="upload-input-${timestamp}" accept="image/*" hidden>
                    </div>
                `);
                        $(".image-upload-container").append(newUploadBox);
                    };

                    reader.readAsDataURL(file);
                }
            });

            // Remove image
            uploadContainer.on("click", ".remove-icon", function () {
                const parentBox = $(this).parent();
                const imgSrc = parentBox.find("img").attr("src");

                // Find and remove the corresponding file from `uploadedImages`
                uploadedImages = uploadedImages.filter(file => {
                    const tempReader = new FileReader();
                    tempReader.readAsDataURL(file);
                    return tempReader.result !== imgSrc; // Compare base64 data
                });

                parentBox.remove();
            });

            // Handle image upload when "Next" button is clicked
            $(document).on('click', '#next2', function (event) {
                event.preventDefault();

                if (uploadedImages.length === 0) {
                    alert("Please select at least one image!");
                    return;
                }

                let campaignMsgId = $("#campaignMsgId").val(); // Get campaign ID
                let formData = new FormData();

                // Append campaignMsgId
                formData.append("campaignMsgId", parseInt(campaignMsgId) || 0);
;

                // Append images to FormData
                uploadedImages.forEach((file, index) => {
                    formData.append(`images[${index}]`, file);
                });

                $.ajax({
                    url: "/CampaignMessages/UploadImages",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        if (response.success) {
                            alert("Images uploaded successfully!");
                            uploadedImages = []; // Clear array
                            debugger
                            // Reset image upload container
                            $(".image-upload-container").html(`
                        <div class="upload-box">
                            <label for="upload-input">+</label>
                            <input type="file" id="upload-input" accept="image/*" hidden>
                        </div>
                    `);
                        } else {
                            alert("Image upload failed!");
                        }
                    },
                    error: function () {
                        alert("Error uploading images!");
                    }
                });
            });


        });
    </script>

    
}
<style>
    .image-upload-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .upload-box {
        width: 100px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e0e0e0;
        border: 2px dashed #bbb;
        border-radius: 10px;
        position: relative;
        cursor: pointer;
    }

        .upload-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .upload-box .remove-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff5e57;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.9;
        }

    .upload-label {
        font-size: 24px;
        color: #555;
    }

        .upload-label:hover {
            color: #1778f2;
        }
</style>