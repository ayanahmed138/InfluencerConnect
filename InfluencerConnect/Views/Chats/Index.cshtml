@model IEnumerable<InfluencerConnect.Models.ChatsViewModel>


<!-- Icons -->
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/fonts/fontawesome.css" />
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/fonts/tabler-icons.css" />
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/fonts/flag-icons.css" />

<!-- Core CSS -->
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/css/rtl/core.css" class="template-customizer-core-css" />
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/css/rtl/theme-default.css" class="template-customizer-theme-css" />

<!-- Vendors CSS -->
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/libs/bootstrap-maxlength/bootstrap-maxlength.css" />

<!-- Page CSS -->
<link rel="stylesheet" href="~/Content/chat style/assets/vendor/css/pages/app-chat.css">

<!-- Core JS -->
<!-- build:js chat style/assets/vendor/js/core.js -->

<script src="chat style/assets/vendor/js/bootstrap.js"></script>
<script src="chat style/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar  ">
    <div class="layout-container">
        <!-- Layout container -->
        <div class="layout-page">
            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->
                <div class="container-xxl flex-grow-1 container-p-y">
                    <div class="app-chat card overflow-hidden">
                        <div class="row g-0">
                            <!-- Chat & Contacts -->
                            <div class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end" id="app-chat-contacts">
                                <div class="sidebar-header h-px-75 px-5 border-bottom d-flex align-items-center">
                                    <div class="d-flex align-items-center me-6 me-lg-0">
                                        <div class="flex-shrink-0 avatar avatar-online me-4" data-bs-toggle="sidebar" data-overlay="app-overlay-ex" data-target="#app-chat-sidebar-left">
                                            <img class="user-avatar rounded-circle cursor-pointer" src="@ViewBag.UserImage" alt="Avatar">
                                        </div>
                                        <div class="flex-grow-1 input-group input-group-merge">
                                            <span class="input-group-text" id="basic-addon-search31"><i class="ti ti-search"></i></span>
                                            <input type="text" class="form-control chat-search-input" placeholder="Search...">
                                        </div>
                                    </div>

                                </div>
                                <div class="sidebar-body">
                                    <!-- Chats -->
                                    <ul class="list-unstyled chat-contact-list py-2 mb-0" id="chat-list">
                                        <li class="chat-contact-list-item chat-contact-list-item-title mt-0">
                                            <h5 class="text-primary mb-0">Chats</h5>
                                        </li>
                                        @if (!Model.Any())
                                        {
                                            <li class="chat-contact-list-item chat-list-item-0">
                                                <h6 class="text-muted mb-0">No Chats Found</h6>
                                            </li>
                                        }
                                        else
                                        {

                                            foreach (var chat in Model)
                                            {

                                                <li class="chat-contact-list-item mb-1">
                                                    <a class="d-flex align-items-center" id="chat-item"
                                                       data-user-name="@chat.OtherUserName"
                                                       data-user-img="@chat.OtherUserImg"
                                                       data-chat-id="@chat.ChatId"
                                                       data-other-userid="@chat.OtherUserId">
                                                        <div class="flex-shrink-0 avatar avatar-online">
                                                            <img src="@chat.OtherUserImg" alt="Avatar" class="rounded-circle">
                                                        </div>
                                                        <div class="chat-contact-info flex-grow-1 ms-4">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <h6 class="chat-contact-name text-truncate m-0 fw-normal">@chat.OtherUserName</h6>
                                                                <small class="text-muted">@chat.CreatedOn</small>
                                                            </div>
                                                            <small id="last-message" class="chat-contact-status text-truncate">@chat.LastMessage</small>
                                                        </div>
                                                    </a>
                                                </li>
                                            }

                                        }
                                    </ul>
                                    <!-- Contacts -->

                                </div>
                            </div>
                            <!-- /Chat contacts -->
                            <!-- Chat History -->
                            <div class="col app-chat-history">
                                <div class="chat-history-wrapper">
                                    <div class="chat-history-header border-bottom">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex overflow-hidden align-items-center">
                                                <i class="ti ti-menu-2 ti-lg cursor-pointer d-lg-none d-block me-4" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-contacts"></i>
                                                <div class="flex-shrink-0 avatar avatar-online">
                                                    <img src="" id="chatUserImage" alt="Avatar" class="rounded-circle" data-bs-toggle="sidebar" data-overlay data-target="#app-chat-sidebar-right">
                                                </div>
                                                <div class="chat-contact-info flex-grow-1 ms-4">
                                                    <h6 class="m-0 fw-normal" id="chatUserName"></h6>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="chat-history-body">
                                        <ul class="list-unstyled chat-history">
                                        </ul>
                                    </div>
                                    <!-- Chat message form -->
                                    <div class="chat-history-footer shadow-xs">
                                        <form class="form-send-message d-flex justify-content-between align-items-center ">
                                            <input id="messageInput" class="form-control message-input border-0 me-4 shadow-none" placeholder="Type your message here...">
                                            <div class="message-actions d-flex align-items-center">
                                                <i class="speech-to-text ti ti-microphone ti-md btn btn-sm btn-text-secondary btn-icon rounded-pill cursor-pointer text-heading"></i>
                                                <label for="attach-doc" class="form-label mb-0">
                                                    <i class="ti ti-paperclip ti-md cursor-pointer btn btn-sm btn-text-secondary btn-icon rounded-pill mx-1 text-heading"></i>
                                                    <input type="file" id="attach-doc" hidden>
                                                </label>
                                                <button id="sendButton" class="btn btn-primary d-flex send-msg-btn">
                                                    <span class="align-middle d-md-inline-block d-none">Send</span>
                                                    <i class="ti ti-send ti-16px ms-md-2 ms-0"></i>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- /Chat History -->

                        </div>
                    </div>


                </div>
                <!-- / Content -->
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>
    </div>
</div>



<style>
    .sender {
        color: white;
    }

    .reciever {
        background-color: bisque;
    }

    .chat-contact-list-item.active .chat-contact-name,
    .chat-contact-list-item.active .chat-contact-status,
    .chat-contact-list-item.active small,
    .chat-contact-list-item.active h6 {
        color: white !important;
    }
</style>

@section Scripts {


    <script>



        $(document).ready(function () {
            const senderUserImage = '@ViewBag.UserImage';

            let activateChatId = null;

            // When a chat is clicked
            $('#chat-item').on('click', function (e) {
                e.preventDefault();

                // Remove active class from all items
                $('.chat-contact-list-item').removeClass('active');

                // Add active class to the clicked item's parent <li>
                $(this).closest('.chat-contact-list-item').addClass('active');

                // Get user details
                var userName = $(this).data('user-name');
                var userImg = $(this).data('user-img');
                var chatId = $(this).data('chat-id');

                activeChatId = chatId;

                // Update header
                $('#chatUserName').text(userName);
                $('#chatUserImage').attr('src', userImg);

                // Optional: Clear previous messages
                $('.chat-history').empty();

                // Call backend to load chat messages (example using AJAX)
                $.ajax({
                    url: '/Chats/GetMessages', // Adjust to your controller route
                    type: 'GET',
                    data: { chatId: chatId },
                    success: function (messages) {
                        messages.forEach(function (msg) {
                            var isSender = msg.isSender;
                            var msgHtml = `
        <li class="chat-message ${isSender ? 'chat-message-right' : ''}">
            <div class="d-flex overflow-hidden">
                ${isSender ? '' : `
                <div class="user-avatar flex-shrink-0 me-4">
                    <div class="avatar avatar-sm">
                        <img src="${userImg}" class="rounded-circle" alt="Avatar">
                    </div>
                </div>`}
                <div class="chat-message-wrapper flex-grow-1">
                    <div class="chat-message-text ${isSender ? 'sender' : 'reciever'}">
                        <p class="mb-0" ${isSender ? 'style="color:white;"' : ''}>${msg.content}</p>
                    </div>
                    <div class="${isSender ? 'text-end' : ''} text-muted mt-1">
                        <small>${msg.timestamp}</small>
                    </div>
                </div>
                ${isSender ? `
                <div class="user-avatar flex-shrink-0 ms-4">
                    <div class="avatar avatar-sm">
                        <img src="${senderUserImage}" class="rounded-circle" alt="Avatar">
                    </div>
                </div>` : ''}
            </div>
        </li>`;
                            $('.chat-history').append(msgHtml);
                        });

                        // Scroll to bottom
                        $('.chat-history-body').scrollTop($('.chat-history-body')[0].scrollHeight);
                    }
                });
            });


            // Connect to hub
            var chat = $.connection.chatHub;




            // Receive message from the server
            chat.client.ReceiveMessage = function (senderId, message, timestamp, isSender, chatId) {
                    $('#last-message').text(message);
                if (chatId == activeChatId) {
                    let userImg = $('#chatUserImage').attr('src');

                    var msgHtml = `
                    <li class="chat-message ${isSender ? 'chat-message-right' : ''}">
                    <div class="d-flex overflow-hidden">
                    ${isSender ? '' : `
                    <div class="user-avatar flex-shrink-0 me-4">
                    <div class="avatar avatar-sm">
                    <img src="${userImg}" class="rounded-circle" alt="Avatar">
                    </div>
                    </div>`}
                    <div class="chat-message-wrapper flex-grow-1">
                    <div class="chat-message-text ${isSender ? 'sender' : 'reciever'}" >
                    <p style="${isSender ? 'color: white;' : ''}" class="mb-0">${message}</p>
                    </div>
                    <div class="${isSender ? 'text-end' : ''} text-muted mt-1">
                    <small>${timestamp}</small>
                    </div>
                    </div>
            ${isSender ? `
            <div class="user-avatar flex-shrink-0 ms-4">
                <div class="avatar avatar-sm">
                    <img src="${senderUserImage}" class="rounded-circle" alt="Avatar">
                </div>
            </div>` : ''}
        </div>
    </li>`;

                    $('.chat-history').append(msgHtml);
                    $('.chat-history-body').scrollTop($('.chat-history-body')[0].scrollHeight);
                }
            };

            // Start the connection
            $.connection.hub.start().done(function () {
                console.log("Connected to SignalR hub!");
            }).fail(function (err) {
                console.error("Connection failed: " + err);
            });


            $('#sendButton').click(function (e) {
                e.preventDefault();
                var message = $('#messageInput').val().trim();
                $('#last-message').text(message);
                if (message === '') return;

                var receiverUserId = $('#chat-item').data('other-userid');  // other user ID
                var chatId = $('#chat-item').data('chat-id');          // current chat session ID



                if (!receiverUserId || !chatId) {
                    alert('Please select a chat first.');
                    return;
                }

                chat.server.sendMessage(chatId, receiverUserId, message).done(function () {
                    $('#messageInput').val('');
                }).fail(function (err) {
                    console.error('Send failed: ' + err);
                });
            });
        });


    </script>




}